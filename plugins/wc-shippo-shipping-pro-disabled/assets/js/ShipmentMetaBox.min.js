(function(t){function e(t){this.settings=t,this.labelLoaderPage=new LabelLoaderPage(t.id),jQuery(window).on("load",this.onReady.bind(this)),jQuery(document).on("click","#"+this.settings.metaBoxContentsId+" .showAddShipment",this.onShowAddShipmentForm.bind(this)),jQuery(document).on("click","#"+this.settings.metaBoxContentsId+" .showLinkShipment",this.onShowLinkShipmentForm.bind(this)),jQuery(document).on("change","#"+this.settings.metaBoxContentsId+" .addShipmentForm:not(.skipFetchShippingRates) :input, ."+this.settings.id+".itemsInParcel :input",this.onChange.bind(this)),jQuery(document).on("change","#"+this.settings.metaBoxContentsId+' .addShipmentForm [name="'+this.settings.id+'_package[parcelIdx]"]',this.onParcelChange.bind(this)),jQuery(document).on("change","#"+this.settings.metaBoxContentsId+' .addShipmentForm [name="'+this.settings.id+'_package[cod]"]',this.onCodChange.bind(this)),jQuery(document).on("click","#"+this.settings.metaBoxContentsId+" .fetchShippingRates",this.onFetchRates.bind(this)),jQuery(document).on("click","#"+this.settings.metaBoxContentsId+" .refundShipment",this.onRefundShipment.bind(this)),jQuery(document).on("click","#"+this.settings.metaBoxContentsId+" .cancelCreateShipment",this.onCancelCreateShipment.bind(this)),jQuery(document).on("click","#"+this.settings.metaBoxContentsId+" .createShipment",function(t){this.confirmShipmentDetails(t,this.onCreateShipment.bind(this))}.bind(this)),jQuery(document).on("click","#"+this.settings.metaBoxContentsId+" .buyShipment:not([data-shipment_id])",function(t){this.confirmShipmentDetails(t,this.onBuyShipment.bind(this))}.bind(this)),jQuery(document).on("click","#"+this.settings.metaBoxContentsId+" .buyShipment[data-shipment_id]",this.onBuyShipment.bind(this)),jQuery(document).on("click","#"+this.settings.metaBoxContentsId+" .cancelShipment",this.onCancelShipment.bind(this)),jQuery(document).on("click","#"+this.settings.metaBoxContentsId+" .unlinkShipment",this.onUnlinkShipment.bind(this)),jQuery(document).on("click","#"+this.settings.metaBoxContentsId+" .refreshShipment",this.onRefreshShipment.bind(this)),jQuery(document).on("click","#"+this.settings.metaBoxContentsId+" .linkShipment",this.onLinkShipment.bind(this)),jQuery(document).on("change","."+this.settings.id+".itemsInParcel :input",this.onItemsInParcelChange.bind(this))}e.prototype.block=function(t){t.preventDefault(),jQuery("#"+this.settings.metaBoxContentsId).block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},e.prototype.unblock=function(){jQuery("#"+this.settings.metaBoxContentsId).unblock(),this.scrollTop()},e.prototype.getRequestData=function(t,e){return"action="+this.settings.id+"_"+t+"&orderId="+this.settings.orderId+"&settingsKey="+this.settings.settingsKey+"&"+this.settings.id+"_nonce="+jQuery("#"+this.settings.id+"_nonce").val()+"&"+e},e.prototype.clearErrors=function(){jQuery("#"+this.settings.metaBoxContentsId+" .error").remove()},e.prototype.switchFormToFetchRates=function(){jQuery("#"+this.settings.id+"_package\\[service\\]").parents("tr").remove(),jQuery("#"+this.settings.metaBoxContentsId+" button.fetchShippingRates").css({display:"inline-block"}),jQuery("#"+this.settings.metaBoxContentsId+" button.createShipment").css({display:"none"}),jQuery("#"+this.settings.metaBoxContentsId+" button.buyShipment").css({display:"none"})},e.prototype.switchFormToCreate=function(){jQuery("#"+this.settings.metaBoxContentsId+" button.fetchShippingRates").css({display:"none"}),jQuery("#"+this.settings.metaBoxContentsId+" button.createShipment").css({display:"inline-block"}),jQuery("#"+this.settings.metaBoxContentsId+" button.buyShipment").css({display:"inline-block"})},e.prototype.hideAllForms=function(){jQuery(".addShipmentForm").hasClass("skipFetchShippingRates")?this.switchFormToCreate():this.switchFormToFetchRates(),this.canCreateShipment()&&(jQuery("#"+this.settings.metaBoxContentsId+" .showAddShipment").css({display:"inline-block"}),jQuery("#"+this.settings.metaBoxContentsId+" .showLinkShipment").css({display:"inline-block"})),jQuery("#"+this.settings.metaBoxContentsId+" .shipmentDetails").css({display:"block"}),jQuery("#"+this.settings.metaBoxContentsId+" .linkShipmentForm").css({display:"none"}),jQuery("#"+this.settings.metaBoxContentsId+" .addShipmentForm").css({display:"none"}),jQuery("table ."+this.settings.id+".itemsInParcel").css({display:"none"})},e.prototype.canCreateShipment=function(){return"no"!=this.settings.allowMultipleShipments||0==jQuery("#"+this.settings.metaBoxContentsId+" .shipmentDetails").length},e.prototype.cancelOthersShipmentForms=function(){jQuery(".shipmentMetaBoxForm").not("#"+this.settings.metaBoxContentsId+" .shipmentMetaBoxForm").find(".cancelShipment:visible").click()},e.prototype.showItemsInParcel=function(){jQuery("table ."+this.settings.id+".itemsInParcel").css({display:"table-cell"})},e.prototype.showAddShipmentForm=function(){this.cancelOthersShipmentForms(),this.showItemsInParcel(),jQuery("#"+this.settings.metaBoxContentsId+" .addShipmentForm").css({display:"block"}),jQuery("#"+this.settings.metaBoxContentsId+" .showAddShipment").css({display:"none"}),jQuery("#"+this.settings.metaBoxContentsId+" .showLinkShipment").css({display:"none"}),jQuery("#"+this.settings.metaBoxContentsId+" .shipmentDetails").css({display:"none"}),jQuery("#"+this.settings.id+"_package\\[cod\\]").trigger("change"),jQuery("#"+this.settings.id+"_package\\[parcelIdx\\]").trigger("change")},e.prototype.showLinkShipmentForm=function(){jQuery("#"+this.settings.id+"_shipment_id").val(""),jQuery("#"+this.settings.metaBoxContentsId+" .showAddShipment").css({display:"none"}),jQuery("#"+this.settings.metaBoxContentsId+" .showLinkShipment").css({display:"none"}),jQuery("#"+this.settings.metaBoxContentsId+" .shipmentDetails").css({display:"none"}),jQuery("#"+this.settings.metaBoxContentsId+" .addShipmentForm").css({display:"none"}),jQuery("#"+this.settings.metaBoxContentsId+" .linkShipmentForm").css({display:"block"})},e.prototype.cancelShipmentDetails=function(t){jQuery("#"+this.settings.metaBoxContentsId+' .shipmentDetails[data-shipment_id="'+t+'"]').remove()},e.prototype.isResponseOk=function(t){let e=jQuery("<div>"+t+"</div>");return 0==e.find(".error").length||e.find(".shipmentDetails").length>0},e.prototype.displayResponse=function(t){if("0"==t.trim())return;let e=jQuery("#"+this.settings.metaBoxContentsId);e.prepend(t),e.trigger("updated")},e.prototype.buildTemplate=function(t,e){for(let n=0;n<e.length;++n){let i=e[n];t=t.replace("{"+i.placeholder+"}",i.value)}return t=t.replace(/\{[^\}]+\}/g,""),t},e.prototype.preparePlaceholders=function(t){let e=[],n=this;return jQuery(t).filter("[name]").each(function(){let t=jQuery(this),i=t.attr("name").replace(n.settings.id+"_",""),s=t.val();t.is("select")?s=t.find("option:selected").text():t.is("input[type=checkbox]")&&(s=t.is(":checked")?"Y":"N"),e.push({placeholder:i,value:s})}),e},e.prototype.buildConfirmationContents=function(t){let e=[];for(let n in t){let i="";i="address"==n?"_shipping_address_1":"address_2"==n?"_shipping_address_2":"phone"==n?"_billing_phone":"_shipping_"+n;let s=t[n];e.push({placeholder:i,value:s})}return e.push({placeholder:"_shipping_first_name",value:""}),e.push({placeholder:"_shipping_last_name",value:""}),e=e.concat(this.preparePlaceholders("#"+this.settings.metaBoxContentsId+" :input")),this.buildTemplate(this.settings.confirmShipmentDetailsTemplate,e)},e.prototype.confirmShipmentDetails=function(t,e){if("no"==this.settings.requireToConfirmShipmentDetails)return e(t);let n=jQuery('<div id="shipmentMetaBox_confirmShipmentDetails"/>'),i=null;return jQuery('input[name="'+this.settings.id+'_package[return]"]').is(":checked")&&(i=this.buildConfirmationContents(this.settings.origin)),null===i&&(i=this.buildConfirmationContents(this.settings.destination)),n.html(i),jQuery("body").append(n),n.dialog({title:this.settings.confirmShipmentDetailsTitle,modal:!0,width:600,height:"auto",resizable:!1,close:function(){jQuery('<div id="shipmentMetaBox_confirmShipmentDetails"/>').remove()},buttons:[{text:this.settings.confirmButtonText,class:"button",click:function(){e(t),n.dialog("close")}},{text:this.settings.cancelButtonText,class:"button",click:function(){n.dialog("close")}}]}),jQuery(".ui-dialog-buttonset button").attr("class","button"),jQuery(".ui-dialog-titlebar").removeClass("ui-widget-header ui-corner-all"),!1},e.prototype.onReady=function(){jQuery("body").addClass("shipmentMetaBox"),jQuery("#"+this.settings.metaBoxContentsId+" [type=checkbox]").switchify(),"block"==jQuery("#"+this.settings.metaBoxContentsId+" .addShipmentForm.shipmentMetaBoxForm ").css("display")&&this.showItemsInParcel()},e.prototype.onShowAddShipmentForm=function(t){t.preventDefault(),this.showAddShipmentForm()},e.prototype.onShowLinkShipmentForm=function(t){t.preventDefault(),this.showLinkShipmentForm()},e.prototype.onItemsInParcelChange=function(t){let e=0,n=jQuery("."+this.settings.id+".itemsInParcel.value :input[data-item-id]");for(let t=0;t<n.length;++t){let i=jQuery(n[t]),s=i.data("item-id"),o=jQuery("."+this.settings.id+".itemsInParcel.quantity :input[data-item-id="+s+"]"),a=parseFloat(i.val())*parseFloat(o.val());a>0&&(e+=a)}n.length>0&&(jQuery("#"+this.settings.id+"_package\\[value\\]").val(e.toFixed(2)),jQuery("#"+this.settings.id+"_package\\[cod_amount\\]").val(e.toFixed(2)))},e.prototype.onParcelChange=function(t){let e=this.settings.parcels,n=parseInt(jQuery("#"+this.settings.id+"_package\\[parcelIdx\\]").val());if(void 0===e[n])return;let i=jQuery(),s=e[n];for(let t in s)i=jQuery('[name="'+this.settings.id+"_package["+t+']"]'),i.length>0&&"currency"!==t&&i.val(s[t]);jQuery("."+this.settings.id+".itemsInParcel.quantity :input").val("0");for(let t in s.items){let e=s.items[t];i=jQuery('[name="'+this.settings.id+"_package[items]["+t+'][quantity]"]'),i.val(e.quantity)}this.onItemsInParcelChange(t)},e.prototype.onCodChange=function(t){let e=jQuery(t.target),n=e.is(":checked");e.parents("table.form-table").find(".cod_field").each(function(t,e){let i=jQuery(e).parents("tr");n?i.removeClass("hide"):i.addClass("hide")})},e.prototype.onChange=function(t){if("no"==this.settings.requireToFetchShippingRates)return;let e=jQuery(t.target);e.attr("id")!==this.settings.id+"_package[service]"&&this.switchFormToFetchRates()},e.prototype.onFetchRates=function(t){this.block(t);let e=this.getRequestData("fetchShippingRates",this.getSerializedFormData()),n=this;jQuery.post(this.settings.ajaxurl,e,function(t){n.onFetchRatesResponse(t)})},e.prototype.onFetchRatesResponse=function(t){this.clearErrors();let e=jQuery("<table>").html(t),n=e.find(".error");if(n.length>0){let t=jQuery("<div>").append(n.clone()).html();n.remove(),this.displayResponse(t)}e.find("tr").length>0&&(this.switchFormToCreate(),jQuery("#"+this.settings.metaBoxContentsId+" .shipmentMetaBoxForm:visible table > tbody").prepend(e.html())),this.unblock()},e.prototype.onRefundShipment=function(t){if(!confirm(this.settings.confirmRefundText))return;this.block(t);let e=jQuery(t.target).data("shipment_id"),n=this.getRequestData("refundShipment","shipmentId="+e),i=this;jQuery.post(this.settings.ajaxurl,n,function(t){i.onShipmentResponse(e,t)})},e.prototype.onCancelCreateShipment=function(t){this.block(t);let e=this.getRequestData("cancelCreateShipment",""),n=this;jQuery.post(this.settings.ajaxurl,e,function(t){n.onCreateOrCancelResponse(t)})},e.prototype.onCreateShipment=function(t){this.block(t);jQuery(t.target).closest(".addShipmentForm");let e=this.getRequestData("createShipment",this.getSerializedFormData()),n=this;jQuery.post(this.settings.ajaxurl,e,function(t){n.onCreateOrCancelResponse(t)})},e.prototype.onCreateOrCancelResponse=function(t){this.clearErrors(),this.displayResponse(t),this.isResponseOk(t)&&this.hideAllForms(),this.unblock()},e.prototype.onBuyShipment=function(t){this.block(t);let e="",n=jQuery(t.target),i=n.hasClass("download");i&&this.labelLoaderPage.open();let s=n.data("shipment_id");e=s?"shipmentId="+s:this.getSerializedFormData(),e=this.getRequestData("buyShipment",e),jQuery.post(this.settings.ajaxurl,e,function(t){this.onShipmentResponse(s,t,i)}.bind(this))},e.prototype.onShipmentResponse=function(t,e,n){this.clearErrors();let i=this.isResponseOk(e);if(i&&this.cancelShipmentDetails(t),this.displayResponse(e),i&&!t&&(t=jQuery(e).data("shipment_id")),i&&n){let e=jQuery('a[data-shipment_id="'+t+'"].download').attr("href");e?this.labelLoaderPage.navigate(e):this.labelLoaderPage.close()}i?this.hideAllForms():this.labelLoaderPage.close(),this.unblock()},e.prototype.onCancelShipment=function(t){if(!confirm(this.settings.confirmDeleteText))return;this.block(t);let e=jQuery(t.target).data("shipment_id"),n=this.getRequestData("cancelShipment","shipmentId="+e),i=this;jQuery.post(this.settings.ajaxurl,n,function(t){i.onShipmentResponse(e,t)})},e.prototype.onUnlinkShipment=function(t){if(!confirm(this.settings.confirmUnlinkText))return;this.block(t);let e=jQuery(t.target).data("shipment_id"),n=this.getRequestData("unlinkShipment","shipmentId="+e),i=this;jQuery.post(this.settings.ajaxurl,n,function(t){i.onShipmentResponse(e,t)})},e.prototype.onRefreshShipment=function(t){let e=jQuery(t.target).data("shipment_id");this.refreshShipment(e)},e.prototype.onLinkShipment=function(t){let e=jQuery("#"+this.settings.id+"_shipment_id").val();this.refreshShipment(e)},e.prototype.refreshShipment=function(t){this.block(event);let e=this.getRequestData("refreshShipment","shipmentId="+t),n=this;jQuery.post(this.settings.ajaxurl,e,function(e){n.onShipmentResponse(t,e)})},e.prototype.scrollTop=function(){let t=jQuery("#"+this.settings.metaBoxContentsId).offset().top,e=jQuery('[name="'+this.settings.id+'_package[service]"]');e.length>0&&(t=e.offset().top,e.focus()),t-=300,jQuery([document.documentElement,document.body]).animate({scrollTop:t})},e.prototype.getSerializedFormData=function(){let t=jQuery("#"+this.settings.metaBoxContentsId+" :input, ."+this.settings.id+".itemsInParcel :input").not("button");return t.filter('[type="checkbox"][value="no"]:checked').val("1"),t.serialize()},new e(t)})(shipmentmetabox_settings);